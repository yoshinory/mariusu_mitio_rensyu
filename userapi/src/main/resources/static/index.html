<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>User管理</title>
</head>
<body>

  <h1>ユーザー管理</h1>

  <!-- 登録フォーム -->
  <h2>ユーザー登録</h2>
  <form id="userForm">
    <label>
      名前：
      <input type="text" id="nameInput" placeholder="例：Taro" required>
    </label>
    <button type="submit">登録</button>
  </form>

  <p id="message"></p>

  <!-- 一覧表示 -->
  <h2>ユーザー一覧</h2>
  <ul id="userList"></ul>

  <script>
    const form = document.getElementById("userForm");
    const nameInput = document.getElementById("nameInput");
    const message = document.getElementById("message");
    const userList = document.getElementById("userList");

    // 一覧取得（GET /api/users）
    async function loadUsers() {
      userList.innerHTML = "";

      const response = await fetch("/api/users");
      if (!response.ok) {
        message.textContent = `一覧取得に失敗しました（HTTP ${response.status}）`;
        return;
      }

      const users = await response.json();

      users.forEach(user => {
        const li = document.createElement("li");

        // 表示モード用（通常表示）
        const nameSpan = document.createElement("span");
        nameSpan.textContent = `${user.id} : ${user.name} `;

        // 編集モード用（最初は非表示）
        const editInput = document.createElement("input");
        editInput.type = "text";
        editInput.value = user.name;
        editInput.style.display = "none";

        // 変更ボタン（通常表示）
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "変更";

        // 保存ボタン（最初は非表示）
        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.textContent = "保存";
        saveBtn.style.display = "none";

        // キャンセルボタン（最初は非表示）
        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.textContent = "キャンセル";
        cancelBtn.style.display = "none";

        // 削除ボタン（通常表示）
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "削除";

        // 編集モードへ切り替え
        editBtn.onclick = () => {
          nameSpan.style.display = "none";
          editBtn.style.display = "none";

          editInput.style.display = "inline";
          saveBtn.style.display = "inline";
          cancelBtn.style.display = "inline";
        };

        // 表示モードへ戻す（キャンセル）
        cancelBtn.onclick = () => {
          editInput.value = user.name;

          editInput.style.display = "none";
          saveBtn.style.display = "none";
          cancelBtn.style.display = "none";

          nameSpan.style.display = "inline";
          editBtn.style.display = "inline";
        };

        // 保存（PUT /api/users/{id}）
        saveBtn.onclick = async () => {
          const newName = editInput.value.trim();
          if (!newName) {
            alert("名前を入力してください");
            return;
          }

          const res = await fetch(`/api/users/${user.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: newName })
          });

          if (res.ok) {
            message.textContent = "更新しました";
            await loadUsers();
          } else {
            message.textContent = `更新に失敗しました（HTTP ${res.status}）`;
          }
        };

        // 削除（DELETE /api/users/{id}）
        deleteBtn.onclick = async () => {
          if (!confirm("本当に削除しますか？")) return;

          const res = await fetch(`/api/users/${user.id}`, { method: "DELETE" });

          if (res.ok) {
            message.textContent = "削除しました";
            await loadUsers();
          } else {
            message.textContent = `削除に失敗しました（HTTP ${res.status}）`;
          }
        };

        li.appendChild(nameSpan);
        li.appendChild(editInput);
        li.appendChild(editBtn);
        li.appendChild(saveBtn);
        li.appendChild(cancelBtn);
        li.appendChild(deleteBtn);

        userList.appendChild(li);
      });
    }

    // 登録（POST /api/users）
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      if (!name) {
        message.textContent = "名前を入力してください";
        return;
      }

      const res = await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });

      if (res.ok) {
        message.textContent = "登録しました";
        nameInput.value = "";
        await loadUsers();
      } else {
        message.textContent = `登録に失敗しました（HTTP ${res.status}）`;
      }
    });

    // 初回読み込み
    loadUsers();
  </script>

</body>
</html>

